<!DOCTYPE html>
<html>
    <head>
        <title>Pong</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            body,html{
                margin:0;
                text-align:center;
            }
            .main{
                padding:0;
                max-width:99vw;
                max-height:99vh;
                width:fit-content;
                height:fit-content;
                border:1px black solid;
                position: absolute; 
                left: 0; 
                right: 0; 
                margin-left: auto; 
                margin-right: auto;
                overflow: hidden;
            }
            canvas{
                cursor: none;
                border-bottom:1px solid black;
            }
            #outputlog{
                margin-left:auto;
                margin-right:auto;
                display:inline-block;
                height:200px;
                width:100%;
                padding-right: 17px;
                overflow-y:scroll;
                box-sizing: content-box;
            }
        </style>
    </head>
    <body>
        <div class="main">
            <canvas id="gameScreen_Main"></canvas><br>
            <div id="outputlog">
                Welcome to pong!<br>
                Wins: <span id="score"></span><br>
                High Score: <span id="highScore"></span><br>
                Losses: <span id="losses"></span><br>
                Win/Loss Ratio: <span id="wlratio"></span>
            </div>
        </div>
        <script src="general.js"></script>
        <script>
            "use strict";
            let minScreenSize = Math.min(viewport.width,viewport.height);
            let maxScreenSize = Math.max(viewport.width,viewport.height);
            let screenSize = {
                x:0,
                y:0
            }
            if(minScreenSize==viewport.width){
                screenSize.x = viewport.width;
                screenSize.y = (viewport.width+viewport.height/2);
            }else if(minScreenSize==viewport.height){
                screenSize.x = (viewport.width+viewport.height/2);
                screenSize.y = viewport.height;
            }
            screenSize = {
                x:(screenSize.x>700 ? 700 : screenSize.x),
                y:(screenSize.y>700 ? 700 : screenSize.y)
            }
            const screen = new Screen(screenSize.x,screenSize.y,"gameScreen_Main");
            const game = new Game("Pong", ()=>{
                console.log("game started");
            });
            let paddleSize = {
                width:25,
                height:200
            }
            const player = game.addSprite(new Sprite({
                info:{
                    name:"player",
                    type:"box",
                    colour:{
                        stroke:"green"
                    },
                    speed:{
                        x:300,
                        y:screen.height
                    }
                },
                location:{
                    x:20,
                    y:(screen.height*0.5)-100
                },
                scale:{
                    width:paddleSize.width,
                    height:paddleSize.height
                }
            }, [
                {
                    name:"isMoving",
                    value:false,
                    direction:0,
                    lastPos:0,
                    up:false,
                    down:false
                }
            ]));
            
            const enemy = game.addSprite(new Sprite({
                info:{
                    name:"enemy",
                    type:"box",
                    colour:{
                        stroke:"green"
                    },
                    speed:{
                        x:200,
                        y:200
                    }
                },
                location:{
                    x:screen.width-paddleSize.width-20,
                    y:(screen.height*0.5)-(paddleSize.height/2)
                },
                scale:{
                    width:paddleSize.width,
                    height:paddleSize.height
                }
            }));
            const ball = game.addSprite(new Sprite({
                info:{
                    name:"ball",
                    type:"ball",
                    colour:{
                        stroke:"red",
                        fill:"red"
                    },
                    speed:{
                        x:screen.width/5 < 150 ? 150 : screen.width/5,
                        y:150
                    }
                },
                location:{
                    x:screen.width/2,
                    y:screen.height/2
                },
                scale:{
                    radius:15
                }
            }, [
                {
                    name:"maxSpeed",
                    value:700
                }
            ]));
            const invisBall = game.addSprite(new Sprite({
                info:{
                    name:"invis ball",
                    type:"ball",
                    hidden:true,
                    opacity:0.5,
                    speed:{
                        x:ball.speed.x+200,
                        y:200
                    }
                },
                location:{
                    x:screen.width/2,
                    y:screen.height/2
                },
                scale:{
                    radius:15
                }
            }, [
                {
                    name:"canMove",
                    value:true,
                    finished:false
                }
            ]));
            const mutedIcon = game.addSprite(new Sprite({
                info:{
                    name:"muted icon",
                    type:"image",
                    url:"sprites/muted.png",
                    hidden:true
                },
                location:{
                    x:10,
                    y:10
                },
                scale:{
                    width:35,
                    height:35
                }
            }));
            const speakerIcon = game.addSprite(new Sprite({
                info:{
                    name:"speaker icon",
                    type:"image",
                    url:"sprites/speaker.png"
                },
                location:{
                    x:10,
                    y:10
                },
                scale:{
                    width:35,
                    height:35
                }
            }));
            const pauseIcon = game.addSprite(new Sprite({
                info:{
                    name:"pause icon",
                    type:"image",
                    url:"sprites/paused.png",
                    hidden:true,
                    opacity:0.5
                },
                location:{
                    x:(screen.width/2)-((screen.width*0.75)/2),
                    y:(screen.height/2)-((screen.height*0.75)/2)
                },
                scale:{
                    width:screen.width*0.75,
                    height:screen.height*0.75
                }
            }));
            const sounds = {
                bounce:new SoundWave({
                    name:"bounce",
                    type:"sine",
                    volume:0
                })
            }
            let soundClips = {
                bounce:new SoundClip({
                    name:"bounce clip",
                    file:"audio/bounce.WAV"
                })
            }
            /*
            if (navigator.getAutoplayPolicy(sounds.bounce.audioContext.destination) === "allowed") {
                mutedIcon.hidden = true;
                speakerIcon.hidden = false;
            } else if (navigator.getAutoplayPolicy(sounds.bounce.audioContext.destination) === "allowed-muted") {
                mutedIcon.hidden = false;
                speakerIcon.hidden = true;
            } else if (navigator.getAutoplayPolicy(sounds.bounce.audioContext.destination) === "disallowed") {
                mutedIcon.hidden = false;
                speakerIcon.hidden = true;
            }
            */
            let rand = Math.random();
            ball.velocity = {
                x:rand>=0.5 ? -1 : 1,
                y:rand>=0.5 ? -1 : 1
            }
            let colSwitch = false;
            game.loadSettings();
            let score = game.settings.filter(obj => {
                return obj.name === "Score";
            })[0];
            let muted = game.settings.filter(obj => {
                return obj.name === "Muted";
            })[0];
            let mode = game.settings.filter(obj => {
                return obj.name === "Mode";
            })[0];
            let maxBallSpeed = ball.customProperties[0];
            if(typeof score !== 'object'){
                score = game.addSetting("Score",{
                    wins:0,
                    losses:0,
                    highScore:0
                })
            }
            if(typeof mode !== 'object'){
                mode = game.addSetting("Mode",{
                    players:1,
                    side:"left"
                })
            }
            mode.players = 1;
            score.wins = 0;
            score.losses = 0;
            function setScore(){
                document.querySelector("#score").innerText = score.wins;
                document.querySelector("#highScore").innerText = score.highScore;
                document.querySelector("#losses").innerText = score.losses;
                let wlratio = 1*(score.wins/score.losses);
                if(wlratio==Infinity){
                    wlratio = 1;
                }if(isNaN(wlratio)){
                    wlratio = 0;
                }
                wlratio = Math.round(wlratio*100)/100;
                document.querySelector("#wlratio").innerText = wlratio;
            }
            setScore();
            if(typeof muted !== 'object'){
                muted = game.addSetting("Muted",{
                    is:false
                })
            }
            muted.is = false;
            let isPlayerMoving = player.customProperties.filter(obj => {
                return obj.name === "isMoving";
            })[0];
            sounds.bounce.onload(()=>{
                mutedIcon.hidden = true;
                speakerIcon.hidden = false;
            })
            let totalFrames = 1;
            game.mainLoopFunctions.push(function(){
                let isColliding;
                let colWith = "";
                let delta = game.timeData.delta;
                let rand = Math.random();
                ball.location.x += (ball.speed.x*(ball.velocity.x*delta));
                ball.location.y += (ball.speed.y*(ball.velocity.y*delta));
                let defaultPlayerColour = "black";
                if(mode.players==1){
                    isPlayerMoving.lastPos = player.location.y;
                    if(game.keysDown.KeyW==true){
                        if(player.location.y > 0){
                            player.location.y += (-player.speed.y * delta);
                            screen.mousePos.y = (player.location.y+(player.scale.height/2));
                        }
                    }
                    if(game.keysDown.KeyW==true){
                        if((player.location.y+player.scale.height) < screen.height){
                            player.location.y += (player.speed.y * delta);
                            screen.mousePos.y = (player.location.y+(player.scale.height/2));
                        }
                    }
                    else{
                        if(!(screen.mousePos.y+(player.scale.height/2) > screen.height || screen.mousePos.y-(player.scale.height/2) < 0)){
                            player.location.y = (screen.mousePos.y-(player.scale.height/2));
                        }else{
                            if(screen.mousePos.y+(player.scale.height/2) > screen.height){
                                player.location.y = screen.height-(player.scale.height);
                            }else if(screen.mousePos.y-(player.scale.height/2) < 0){
                                player.location.y = 0;
                            }
                        }
                    }
                }else if(mode.players==0){
                    player.speed.y = player.speed.base.y+((ball.speed.x+ball.speed.y)*0.5)*0.1;
                    if(ball.location.x<screen.width*0.666){
                        let adjustedPlayerLocation = {
                            x:player.location.x+(player.scale.width/2),
                            y:player.location.y+(player.scale.height/2)
                        }
                        if(Math.floor(adjustedPlayerLocation.y) > (Math.floor(ball.location.y))){
                            player.location.y += (-player.speed.y * delta);
                        }else if(Math.floor(adjustedPlayerLocation.y) < (Math.floor(ball.location.y))){
                            player.location.y += (player.speed.y * delta);
                        }
                    }
                }
                else if(mode.player==2){

                }
                if(mode.players<2){
                    enemy.speed.y = enemy.speed.base.y+((ball.speed.x+ball.speed.y)*0.5)*0.1;
                    if(ball.location.x>screen.width/3){
                        let adjustedEnemyLocation = {
                            x:enemy.location.x+(enemy.scale.width/2),
                            y:enemy.location.y+(enemy.scale.height/2)
                        }
                        if(Math.floor(adjustedEnemyLocation.y) > (Math.floor(ball.location.y))){
                            if(enemy.location.y > 0){
                                enemy.location.y += (-enemy.speed.y * delta);
                            }
                        }else if(Math.floor(adjustedEnemyLocation.y) < (Math.floor(ball.location.y))){
                            if((enemy.location.y+enemy.scale.height) < screen.height){
                                enemy.location.y += (enemy.speed.y * delta);
                            }
                        }
                    }
                }
                isPlayerMoving.value = (player.location.y!==isPlayerMoving.lastPos) ? true : false;
                if((ball.location.x+ball.scale.radius)>=screen.width/2){
                    isColliding = ball.isColliding(enemy);
                    colWith = "enemy";
                }else{
                    isColliding = ball.isColliding(player);
                    colWith = "player";
                }
                if(ball.location.x<=0+(ball.scale.radius) || ball.location.x >= screen.width - (ball.scale.radius)){ // wins or loses
                    if(ball.location.x >= screen.width - (ball.scale.radius)){
                        if(!muted.is){
                            sounds.bounce.play({
                                time:0.75,
                                type:"triangle",
                                fade:true,
                                frequency:550
                            });
                        }
                        score.wins+=1;
                        if(score.wins>score.highScore){
                            score.highScore = score.wins;
                        }
                        game.saveSettings();
                        setScore();
                    }
                    if(ball.location.x<=0+(ball.scale.radius)){
                        if(!muted.is){
                            sounds.bounce.play({
                                time:0.75,
                                type:"triangle",
                                fade:true,
                                frequency:220
                            });
                        }
                        score.losses+=1;
                        game.saveSettings();
                        setScore();
                    }
                    ball.location = {
                        x:screen.width/2,
                        y:screen.height/2
                    }
                    ball.velocity = {
                        x:rand>=0.5 ? -1 : 1,
                        y:rand>=0.5 ? -1 : 1
                    }
                    ball.speed.y = ball.speed.base.y + (rand * 50);
                    enemy.location.y = (screen.height/2)-(enemy.scale.height/2);
                    if(mode.players<1){
                        player.location.y = (screen.height/2)-(player.scale.height/2);
                    }
                }else{
                    if (isColliding) {
                        if(colSwitch==false){
                            colSwitch = true;
                            rand = Math.random();
                            if(colWith=="enemy"){
                                ball.speed.x = ball.speed.x + 25*delta > maxBallSpeed.value ? maxBallSpeed.value : ball.speed.x + 15;
                                if(!muted.is){
                                    sounds.bounce.play({
                                        time:0.2,
                                        fade:true,
                                        frequency:400 + rand*40
                                    });
                                }
                                ball.velocity.x = -1;
                                ball.speed.y = ball.speed.base.y + (rand * 50);
                            }else{
                                ball.speed.x = ball.speed.x + 25*delta > maxBallSpeed.value ? maxBallSpeed.value : ball.speed.x + 15;
                                if(!muted.is){
                                    sounds.bounce.play({
                                        time:0.2,
                                        fade:true,
                                        frequency:600 + rand*40
                                    });
                                }
                                ball.velocity.x = 1;
                                if(mode.players>0){
                                    if(isPlayerMoving.lastPos > player.location.y){
                                        ball.velocity.y = -1;
                                    }else if(isPlayerMoving.lastPos < player.location.y){
                                        ball.velocity.y = 1;
                                    }
                                }
                                ball.speed.y = isPlayerMoving.value == true ? ball.speed.y + (ball.speed.base.y*0.5) : ball.speed.y;
                            }
                        }
                    }else{
                        colSwitch = false;
                    }
                    if(ball.location.y <= 0+(ball.scale.radius) || ball.location.y >= screen.height - (ball.scale.radius)){
                        if(colSwitch==false){
                            if(!muted.is){
                                sounds.bounce.play({
                                    time:0.2,
                                    fade:true,
                                    frequency:500 + rand*40
                                });
                            }
                            colSwitch = true;
                            ball.velocity.y = ball.location.y >= screen.height - (ball.scale.radius) ? -1 : 1;
                        }
                    }else{
                        colSwitch = false;
                    }
                }
                totalFrames+=1;
            })
            document.addEventListener("keyup", function(e){
                if(e.code == "Escape"){
                    if(game.running){
                        pauseIcon.hidden = false;
                        pauseIcon.draw();
                        screen.documentObject.style.cursor = "default";
                    }else{
                        pauseIcon.hidden = true;
                        pauseIcon.draw();
                        screen.documentObject.style.cursor = "none";
                    }
                }
                if(e.code=="KeyM"){
                    muted.is = muted.is ? false : true;
                    mutedIcon.hidden = !muted.is;
                    speakerIcon.hidden = muted.is;
                }
            })
            game.play();
        </script>
    </body>
</html>